"use strict";window.$===void 0&&(window.$=MyAMS.$);const msc={catalog:{changeActivity:e=>{const s=$("html").attr("lang"),t=$(e.currentTarget).parents("form"),o=$('select[name$=".widgets.reference"]',t),n=o.val(),i=$(`input[name$=".widgets.${s}.title"]`,t),a=$('select[name$=".widgets.data_type"]',t);n&&MyAMS.require("ajax").then(()=>{MyAMS.ajax.get(`${window.location.origin}/api/content/rest/${n}/info`).then(e=>{i.val(e.info.title),e.info.data_type&&a.val(e.info.data_type.name).trigger("change")})})},getPrincipalID:e=>{const t=$(e.currentTarget),n=t.siblings("select"),s=n.val();MyAMS.require("modal").then(()=>{MyAMS.modal.open(`edit-user-profile.html?principal_id=${s}`)})},setIllustration:(e,t,n)=>{const s=$(e.currentTarget),o=s.html(),i=s.parents(".media-thumbnail"),a=i.parents(".gallery"),r=a.data("ams-location");MyAMS.require("ajax","alert","i18n").then(()=>{MyAMS.alert.bigBox({status:"warning",icon:"fas fa-bell",title:MyAMS.i18n.WARNING,message:"Confirmez-vous le remplacement de l'illustration ?",successLabel:MyAMS.i18n.CONFIRM,cancelLabel:MyAMS.i18n.BTN_CANCEL}).then(e=>{if(e!=="success")return;s.html('<i class="fas fa-fw fa-spinner fa-spin"></i>'),MyAMS.ajax.post(`${r}/set-${n}-illustration.json`,{object_name:i.data("ams-element-name")}).then(e=>{MyAMS.alert.smallBox({status:e.status,message:e.message,icon:"fa-info-circle",timeout:3e3}),s.html(o)}).catch(()=>{s.html(o)})})})},setContentIllustrationFromGallery:(e,t)=>{msc.catalog.setIllustration(e,t,"content")},setLinkIllustrationFromGallery:(e,t)=>{msc.catalog.setIllustration(e,t,"link")}},session:{setProgramLength:e=>{const t=$(e.currentTarget),n=t.data("msc-length");MyAMS.require("ajax").then(()=>{MyAMS.ajax.post("set-my-program-length.json",{length:n}).then(MyAMS.ajax.handleJSON)})},confirmDelete:e=>{MyAMS.require("ajax","alert","i18n","form").then(()=>{MyAMS.alert.bigBox({status:"danger",icon:"fas fa-bell",title:"Confirmez-vous la suppression de cette séance ?",message:"Cette séance a fait l'objet de plusieurs demandes de réservations.<br />Si vous la supprimez, l'ensemble des réservations qui s'y appliquent seront également supprimées !"}).then(t=>{if(t==="success"){const t=e.parents("form");MyAMS.form.submit(t)}})})},changeActivity:e=>{const o=$("html").attr("lang"),t=$(e.currentTarget).parents("form"),s=$('select[name$=".widgets.activity"]',t),n=s.val();n&&MyAMS.require("ajax").then(()=>{MyAMS.ajax.get(`${window.location.origin}/api/content/rest/${n}/info`).then(e=>{const n=e.info?.catalog_entry?.duration;if(n){const e=$(`input[name$=".widgets.start_date"]`,t),s=new Date(e.val()),o=$(`input[id$="-widgets-end_date-dt"]`,t),i=new Date(s.getTime()+n*6e4);o.data("datetimepicker").date(i)}})})},roomChanged:(e,t)=>{const n=t.theater_name,s=$(e.currentTarget).val();MyAMS.require("ajax").then(()=>{MyAMS.ajax.get(`${window.location.origin}/api/msc/${n}/room/${s}`).then(e=>{const n=e.room?.capacity;n&&$(`input[id="${t.target}"]`).val(n)})})}},calendar:{transposed:localStorage.getItem("msc.transposed")==="true",synchronized:localStorage.getItem("msc.synchronized")==="true",scrolling:localStorage.getItem("msc.scrolling")==="true",init:(e,t,n)=>{n.viewDidMount=MyAMS.msc.calendar.onMountedView,n.eventContent=MyAMS.msc.calendar.setEventContent,n.eventClassNames=MyAMS.msc.calendar.setEventClassNames,n.eventDidMount=MyAMS.msc.calendar.renderedEvent,n.dateClick=MyAMS.msc.calendar.addEvent,n.eventClick=MyAMS.msc.calendar.showEvent,n.eventDrop=MyAMS.msc.calendar.dropEvent,n.eventResize=MyAMS.msc.calendar.resizeEvent,n.eventReceive=MyAMS.msc.calendar.receiveEvent,n.datesSet=MyAMS.msc.calendar.setDates},onMountedView:e=>{if(MyAMS.msc.calendar.scrolling){const t=$(e.el),n=$(".fc-scroller",t);n.off("scroll").on("scroll",e=>{const t=$(e.currentTarget).scrollTop();$(".fc-scroller",$(".calendar tbody td")).scrollTop(t)})}},refresh:(e,t)=>{typeof t=="object"&&(e=t.room_id);const n=$(`.calendar[data-msc-room="${e}"]`).data("msc-calendar");n&&n.refetchEvents()},refreshAll:()=>{$(".calendar").each((e,t)=>{$(t).data("msc-calendar").refetchEvents()})},afterInit:(e,t,n)=>{if(t.data("msc-calendar",n),msc.calendar.transposed){$(".calendar-wrapper").addClass("transposed");const e=$('a[href="MyAMS.msc.calendar.transpose"]');e.exists()&&e.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary")}if(msc.calendar.synchronized){const e=$('a[href="MyAMS.msc.calendar.synchronize"]');e.exists()&&e.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary")}if(msc.calendar.scrolling){const e=$('a[href="MyAMS.msc.calendar.scroll"]');e.exists()&&e.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary")}},setEventContent:e=>{const t=e.event.title.split(`
`);return t.length>1?{html:`<strong>${t[0]}</strong><br />${t[1]||""}`}:t[0]?{html:`<strong>${t[0]}</strong>`}:{html:"--"}},setEventClassNames:e=>{let t="";return e.event.extendedProps.temporary&&(t="font-italic"),e.event.extendedProps.borderWidth&&(t+=` border-${e.event.extendedProps.borderWidth}`),e.event.extendedProps.borderStyle&&(t+=` border-${e.event.extendedProps.borderStyle}`),e.event.extendedProps.backgroundImage&&(t+=` event-bg-${e.event.extendedProps.backgroundImage}`),t},renderedEvent:e=>{const n=$(e.el);n.data("msc-event",e.event).contextMenu({menuSelector:"#eventMenu"});const t=e.event.title.split(`
`);t.length>1?n.tooltip({title:`<strong>${t[0]}</strong><br />Places: ${t[1].replace(/\(/,"").replace(/\)/,"")||""}`,html:!0}):t[0]?n.tooltip({title:`<strong>${t[0]}</strong>`,html:!1}):n.tooltip({title:"--",html:!1})},transpose:e=>{const t=$(".calendar-wrapper");t.toggleClass("transposed"),$(".calendar").each((e,t)=>{$(t).data("msc-calendar").render()}),e.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary");const n=t.hasClass("transposed");localStorage.setItem("msc.transposed",n),msc.calendar.transposed=n},synchronize:e=>{if(msc.calendar.synchronized=!msc.calendar.synchronized,msc.calendar.synchronized){const e=$(".calendar"),t=e.first().data("msc-calendar");try{msc.calendar.synchronized=!1,e.each((e,n)=>{if(e===0)return;const s=$(n).data("msc-calendar");s.changeView(t.view.type,t.view.currentStart)})}finally{msc.calendar.synchronized=!0}}e.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary"),localStorage.setItem("msc.synchronized",e.hasClass("btn-secondary"))},scroll:e=>{const t=$(".fc-scroller",$(".calendar tbody td"));msc.calendar.scrolling=!msc.calendar.scrolling,msc.calendar.scrolling?t.on("scroll",e=>{const n=$(e.currentTarget).scrollTop();t.scrollTop(n)}):t.off("scroll"),e.button("toggle").toggleClass("btn-light").toggleClass("btn-link").toggleClass("btn-secondary").toggleClass("border-secondary"),localStorage.setItem("msc.scrolling",e.hasClass("btn-secondary"))},updating:[],setDates:e=>{function n(){msc.calendar.updating.splice(0,msc.calendar.updating.length)}if($(".tooltip").tooltip("hide"),!msc.calendar.synchronized)return;const t=msc.calendar.updating;if(t.indexOf(e.view.calendar)>-1)return;t.push(e.view.calendar);const s=$(".calendar");try{s.each((n,s)=>{const i=$(s),o=i.data("msc-calendar");if(o){if(t.indexOf(o)>-1||o===e.view.calendar)return;o.changeView(e.view.type,e.view.currentStart)}})}finally{setTimeout(n,50)}},addEvent:e=>{const n=e.jsEvent.target,t=$(n).parents(".calendar"),s=t.data("msc-room");if($(".tooltip").tooltip("hide"),t.data("msc-editable")!=="True")return;MyAMS.require("modal").then(()=>{MyAMS.modal.open("add-session.html",{start:e.dateStr,room:s})})},cloneEvent:(e,t)=>()=>{$(".tooltip").tooltip("hide"),MyAMS.require("ajax").then(()=>{const e=t.data("msc-event");MyAMS.ajax.post(`${e.extendedProps.href}/clone-event.json`).then(e=>{e.status==="success"&&MyAMS.msc.calendar.refresh(e.event.room)})})},addEventCallback:(e,t)=>{const n=t.event,s=n.room;$(".tooltip").tooltip("hide"),MyAMS.msc.calendar.refresh(s)},showEvent:e=>{const t=e.event,n=t.extendedProps?.visible;if($(".tooltip").tooltip("hide"),n){const e=t.extendedProps?.href;e&&MyAMS.require("modal").then(()=>{MyAMS.modal.open(`${e}/properties.html`)})}},editEventCallback:(e,t)=>{const n=t.event,s=n.room.toString(),o=$(".calendar");$(".tooltip").tooltip("hide"),o.each((e,t)=>{const o=$(t),a=o.data("msc-room").toString(),i=o.data("msc-calendar");if(a===s)i.refetchEvents();else{const e=i.getEventById(n.id);e&&e.remove()}})},dropEvent:e=>($(".tooltip").tooltip("hide"),new Promise((t,n)=>{const s=e.event,o=s.extendedProps?.href;o?MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(`${o}/update-event.json`,{room:s.extendedProps.room.toString(),start:s.startStr,end:s.endStr}).then(e=>{t(e)},()=>{e.revert(),n()})}):(e.revert(),n())})),resizeEvent:e=>($(".tooltip").tooltip("hide"),new Promise((t,n)=>{const s=e.event,o=s.extendedProps?.href;o?MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(`${o}/update-event.json`,{room:s.extendedProps.room.toString(),start:s.startStr,end:s.endStr}).then(e=>{t(e)},()=>{e.revert(),n()})}):(e.revert(),n())})),receiveEvent:e=>($(".tooltip").tooltip("hide"),new Promise((t,n)=>{const s=e.event,o=s.extendedProps?.href;if(o){const i=$(e.view.calendar.el),a=i.data("msc-calendar"),c=i.data("msc-room"),l=s.extendedProps?.room,r=$(`.calendar[data-msc-room="${l}"]`).data("msc-calendar");MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(`${o}/update-event.json`,{room:c.toString(),start:s.startStr,end:s.endStr}).then(n=>{e.revert(),r.refetchEvents(),a.refetchEvents(),n.messagebox?MyAMS.require("alert").then(()=>{MyAMS.alert.messageBox(n.messagebox),t(n)}):t(n)},()=>{e.revert(),r.refetchEvents(),a.refetchEvents(),n()})})}else e.revert(),n()})),deleteEventCallback:(e,t)=>{const s=$(`.calendar[data-msc-room="${t.room}"]`),o=s.data("msc-calendar"),n=o.getEventById(t.event_id);$(".tooltip").tooltip("hide"),n&&n.remove()},manageEventBookings:(e,t)=>()=>{const e=t.data("msc-event");MyAMS.require("modal").then(()=>{MyAMS.modal.open(`${e.extendedProps.href}/bookings.html`)})}},booking:{seatsChanged:(e,t)=>{const n=parseInt($('[id="form-widgets-nb_participants"]').val())||0,s=parseInt($('[id="form-widgets-nb_accompanists"]').val())||0;$(`[id="${t.target}"]`).val(n+s)},priceChanged:e=>{MyAMS.require("ajax").then(()=>{const n=e.select2,t=n.val(),i=$(n.$element).parents("form"),s=$(`input[name="form.widgets.accompanying_ratio"]`,i),o={};t&&t!=="--NOVALUE--"?(o[e.amsSelect2HelperArgument]=t,MyAMS.ajax.get(e.amsSelect2HelperUrl,o).then(e=>{s.val(e.price.accompanying_ratio)})):s.val(null)})},changeSession:(e,t)=>{const n=t.old_session,s=t.new_session;if(n!==s){const s=t.row_id,e=$(`tr[id="${s}"]`),n=e.parents("table");n.hasClass("datatable")?n.DataTable().row(e).remove().draw():e.remove()}MyAMS.msc.calendar.refreshAll()},previewQuotation:(e,t)=>{MyAMS.require("ajax","alert").then(()=>{const n=$(e.currentTarget).parents("form"),o=$(`input[name="form.widgets.nb_participants"]`,n).val(),i=$(`input[name="form.widgets.nb_accompanists"]`,n).val(),a=$(`input[name="form.widgets.nb_free_accompanists"]`,n).val(),s=$(`select[name="form.widgets.price"]`,n).val(),r=$(`input[name="form.widgets.accompanying_ratio"]`,n).val();!o||!i||!s||s==="--NOVALUE--"?MyAMS.alert.messageBox({status:"error",title:"Prévisualisation impossible !",message:"Vous devez définir le nombre de participants et sélectionner un tarif pour pouvoir prévisualiser le devis..."}):window.open(`${t.target}?`+`nb_participants=${o}&`+`nb_accompanists=${i}&`+`nb_free_accompanists=${a}&`+`price=${s}&`+`ratio=${r||0}`,"_blank")})},resetQuotation:(e,t)=>{const n=t.target;MyAMS.require("ajax").then(()=>{MyAMS.ajax.post(n,{}).then(MyAMS.ajax.handleJSON)})}}};window.MyAMS&&(MyAMS.config.modules.push("msc"),MyAMS.msc=msc,console.debug("MyAMS: MSC module loaded..."))