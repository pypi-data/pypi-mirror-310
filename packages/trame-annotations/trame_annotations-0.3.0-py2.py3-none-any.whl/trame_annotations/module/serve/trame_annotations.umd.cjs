(function(b,t){typeof exports=="object"&&typeof module<"u"?t(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],t):(b=typeof globalThis<"u"?globalThis:b||self,t(b.trame_annotations={},b.Vue))})(this,function(b,t){"use strict";class S{constructor(e,n=0){this.bounds={x:e.x||0,y:e.y||0,width:e.width,height:e.height},this.maxObjects=typeof e.maxObjects=="number"?e.maxObjects:10,this.maxLevels=typeof e.maxLevels=="number"?e.maxLevels:4,this.level=n,this.objects=[],this.nodes=[]}getIndex(e){return e.qtIndex(this.bounds)}split(){const e=this.level+1,n=this.bounds.width/2,i=this.bounds.height/2,l=this.bounds.x,u=this.bounds.y,a=[{x:l+n,y:u},{x:l,y:u},{x:l,y:u+i},{x:l+n,y:u+i}];for(let d=0;d<4;d++)this.nodes[d]=new S({x:a[d].x,y:a[d].y,width:n,height:i,maxObjects:this.maxObjects,maxLevels:this.maxLevels},e)}insert(e){if(this.nodes.length){const n=this.getIndex(e);for(let i=0;i<n.length;i++)this.nodes[n[i]].insert(e);return}if(this.objects.push(e),this.objects.length>this.maxObjects&&this.level<this.maxLevels){this.nodes.length||this.split();for(let n=0;n<this.objects.length;n++){const i=this.getIndex(this.objects[n]);for(let l=0;l<i.length;l++)this.nodes[i[l]].insert(this.objects[n])}this.objects=[]}}retrieve(e){const n=this.getIndex(e);let i=this.objects;if(this.nodes.length)for(let l=0;l<n.length;l++)i=i.concat(this.nodes[n[l]].retrieve(e));return this.level===0?Array.from(new Set(i)):i}remove(e,n=!1){const i=this.objects.indexOf(e);i>-1&&this.objects.splice(i,1);for(let l=0;l<this.nodes.length;l++)this.nodes[l].remove(e);return this.level===0&&!n&&this.join(),i!==-1}update(e,n=!1){this.remove(e,n),this.insert(e)}join(){let e=Array.from(this.objects);for(let i=0;i<this.nodes.length;i++){const l=this.nodes[i].join();e=e.concat(l)}const n=Array.from(new Set(e));if(n.length<=this.maxObjects){this.objects=n;for(let i=0;i<this.nodes.length;i++)this.nodes[i].objects=[];this.nodes=[]}return e}clear(){this.objects=[];for(let e=0;e<this.nodes.length;e++)this.nodes.length&&this.nodes[e].clear();this.nodes=[]}}class N{constructor(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this.data=e.data}qtIndex(e){const n=[],i=e.x+e.width/2,l=e.y+e.height/2,u=this.y<l,a=this.x<i,d=this.x+this.width>i,w=this.y+this.height>l;return u&&d&&n.push(0),a&&u&&n.push(1),a&&w&&n.push(2),d&&w&&n.push(3),n}}function V(r){return t.getCurrentScope()?(t.onScopeDispose(r),!0):!1}function U(){const r=t.ref(1);if(window){let e=function(){r.value=window.devicePixelRatio,n(),i=window.matchMedia(`(resolution: ${r.value}dppx)`),i.addEventListener("change",e,{once:!0})},n=function(){i==null||i.removeEventListener("change",e)},i;e(),V(n)}return{pixelRatio:r}}function J(r){const e=t.ref(0);let n=null,i;const l=()=>{n&&(n.disconnect(),n=null),i=void 0},u=()=>{n=new ResizeObserver(a=>{for(const d of a)e.value=d.contentRect.width})};return t.watchEffect(()=>{i&&(!r.value||r.value!==i)&&l(),r.value&&(n||u(),i=r.value,n==null||n.observe(i),e.value=i.clientWidth)}),V(l),{width:e}}const K={style:{position:"relative"}},Q=["src"],Z=.9,ee=2,z=16,te={ImageDetection:t.defineComponent({__name:"ImageDetection",props:{identifier:{},src:{},annotations:{},categories:{},containerSelector:{},lineWidth:{},lineOpacity:{},selected:{}},emits:["hover"],setup(r,{emit:e}){const n=[[255,0,0],[0,255,0],[0,0,255],[255,255,0],[255,0,255],[0,255,255]],i=[8,8];let l;function u(s,o){return o.x>=s.x+s.width||s.x>=o.x+o.width?!1:!(o.y>=s.y+s.height||s.y>=o.y+o.height)}const a=r,d=t.computed(()=>t.unref(a.annotations)??[]),w=t.computed(()=>t.unref(a.categories)??{}),M=t.computed(()=>t.unref(a.containerSelector)??""),ne=t.computed(()=>t.unref(a.lineOpacity)??Z),se=t.computed(()=>t.unref(a.lineWidth)??ee),x=t.ref(),P=t.computed(()=>{var s;return(s=x.value)==null?void 0:s.getContext("2d",{alpha:!0})}),m=t.ref(),k=t.computed(()=>{var s;return(s=m.value)==null?void 0:s.getContext("2d",{willReadFrequently:!0})}),p=t.ref(),v=t.ref({width:0,height:0}),L=t.ref(),oe=()=>{var s,o;v.value={width:((s=L.value)==null?void 0:s.naturalWidth)??0,height:((o=L.value)==null?void 0:o.naturalHeight)??0}},le=t.computed(()=>d.value.map(s=>{const o=s.category_id??0,c=n[o%n.length];return{...s,color:c}})),Y=t.computed(()=>le.value.reduce((s,o)=>("bbox"in o?s.boxAnnotations.push(o):s.classifications.push(o),s),{boxAnnotations:[],classifications:[]})),T=t.computed(()=>Y.value.boxAnnotations),q=t.computed(()=>Y.value.classifications),ce=U(),{width:ae}=J(x),re=t.computed(()=>x.value?v.value.width/ae.value:1),he=t.computed(()=>se.value*ce.pixelRatio.value*re.value);t.watchEffect(()=>{if(!x.value||!P.value)return;const s=x.value,o=P.value;s.width=v.value.width,s.height=v.value.height,o.clearRect(0,0,s.width,s.height),o.globalCompositeOperation="lighter",o.lineWidth=he.value;const c=ne.value;T.value.forEach(({color:h,bbox:f})=>{o.strokeStyle=`rgba(${[...h,c].join(",")})`,o.strokeRect(f[0],f[1],f[2],f[3])})}),t.watchEffect(()=>{if(!k.value||!m.value)return;const s=m.value,o=k.value;s.width=v.value.width,s.height=v.value.height,o.clearRect(0,0,s.width,s.height),l=new S({width:s.width,height:s.height,maxLevels:8,maxObjects:10}),T.value.forEach((c,h)=>{const f=new N({x:c.bbox[0],y:c.bbox[1],width:c.bbox[2],height:c.bbox[3],data:h});l==null||l.insert(f),o.fillStyle="rgb(255, 0, 0)",o.fillRect(c.bbox[0],c.bbox[1],c.bbox[2],c.bbox[3])})});const A=e;function X(){p.value&&(p.value.style.visibility="hidden")}t.onMounted(X);function de(){A("hover",{id:t.unref(a.identifier)})}function ue(){A("hover",{id:""}),X()}function fe(s,o,c){const h=c.getBoundingClientRect(),f=c.width*(s-h.left)/h.width,y=c.height*(o-h.top)/h.height;return[f,y]}const H=t.ref(!1);t.onMounted(()=>{H.value=!0});const pe=t.computed(()=>!H.value||!M.value?null:document.querySelector(M.value)),$=s=>{var C;const{category_id:o,label:c,color:h}=s,f=((C=w.value[o])==null?void 0:C.name)??c??"Unknown",y=document.createElement("li"),g=document.createElement("span");g.style.backgroundColor=`rgb(${h.join(",")})`,g.style.width="10px",g.style.height="10px",g.style.borderRadius="50%",g.style.display="inline-block",g.style.marginRight="0.4rem",y.appendChild(g);const R=document.createElement("span");return R.textContent=f,y.appendChild(R),y};function ge(s){var G;if(!m.value||m.value.width===0||!p.value||!l||!w.value||!a.annotations)return;const o=k.value;if(!o)return;const[c,h]=fe(s.clientX,s.clientY,m.value);if(!(o.getImageData(c,h,1,1).data[0]>0)){p.value.style.visibility="hidden";return}p.value.style.visibility="visible";const g=new N({x:c,y:h,width:2,height:2}),R=l.retrieve(g).filter(j=>u(j,g)).filter(j=>j.data!=null).map(j=>T.value[j.data]).map($);p.value.replaceChildren(...R);const[C,B]=[s.offsetX,s.offsetY];let W=C+i[0],D=B+i[1];const E=p.value.getBoundingClientRect(),F=m.value.getBoundingClientRect(),_=((G=pe.value)==null?void 0:G.getBoundingClientRect())??{left:0,top:0,width:window.innerWidth,height:window.innerHeight},I={left:F.left+W-_.left,top:F.top+D-_.top,width:E.width+z,height:E.height+z};I.left+I.width>_.width&&(W=C-E.width-i[0]),I.top+I.height>_.height&&(D=B-E.height-i[1]),p.value.style.left=`${W}px`,p.value.style.top=`${D}px`}const O=t.ref();t.watchEffect(()=>{if(O.value){if(!q.value.length){O.value.style.visibility="hidden";return}O.value.style.visibility="visible",O.value.replaceChildren(...q.value.map($))}});const me=t.computed(()=>a.selected?"4":"0"),be=t.computed(()=>t.unref(a.src));return(s,o)=>(t.openBlock(),t.createElementBlock("div",K,[t.createElementVNode("img",{ref_key:"img",ref:L,src:be.value,style:t.normalizeStyle([{outlineWidth:me.value+"px"},{width:"100%","outline-style":"dotted","outline-color":"red"}]),onLoad:oe},null,44,Q),t.createElementVNode("canvas",{ref_key:"visibleCanvas",ref:x,style:{width:"100%",position:"absolute",left:"0",top:"0"}},null,512),t.createElementVNode("canvas",{ref_key:"pickingCanvas",ref:m,style:{opacity:"0",width:"100%",position:"absolute",left:"0",top:"0"},onMouseenter:de,onMousemove:ge,onMouseleave:ue},null,544),t.createElementVNode("ul",{ref_key:"labelContainer",ref:p,style:{position:"absolute","z-index":"10",padding:"0.4rem","white-space":"pre","font-size":"small","border-radius":"0.2rem","border-color":"rgba(127, 127, 127, 0.75)","border-style":"solid","border-width":"thin","background-color":"white","list-style-type":"none"}},null,512),t.createElementVNode("ul",{ref_key:"classificationsContainer",ref:O,style:{top:"0.4rem",left:"0.4rem",margin:"0","pointer-events":"none",position:"absolute",padding:"0.4rem","white-space":"pre","font-size":"small","border-radius":"0.2rem","border-color":"rgba(127, 127, 127, 0.75)","border-style":"solid","border-width":"thin","background-color":"white","list-style-type":"none"}},null,512)]))}})};function ie(r){Object.entries(te).forEach(([e,n])=>{r.component(e,n)})}b.install=ie,Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=trame_annotations.umd.cjs.map
